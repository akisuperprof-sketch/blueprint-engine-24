# Gemini Conversation History: Scheme Maker Project

## Context
**Chat ID:** A conversation about analyzing and replicating the "Wado Matrix Generation AI Agent" (later renamed to "Scheme Maker").
**Goal:** Create a clone of the tool using Streamlit and Google Gemini API.

---

## 2025-12-19: Mobile Optimization & Feature Expansion Session

### User Request: Mobile API Quota Issue
スマホでの「Quota Exceeded」エラーを解消したい。有料キーでもエラーが出る理由の特定と対策。

### Initial Analysis
**問題の特定:**
1. PCでは成功するが、スマホでのみStep 4（清書）でエラーが発生
2. 有料APIキーを使用しているにもかかわらず制限エラー
3. ドラフト（Step 3）までは正常に動作

**原因:**
- スマホ写真の高解像度データによるTPM（Tokens Per Minute）制限の超過
- 1分間のデータ転送量上限を、ドラフト生成と清書生成の連続実行で超過
- 実験的モデル（nano-banana-pro-preview）の制限が有料枠でも厳しい

### Phase 1: 機能拡張の実装

#### 1. 新しいアーキタイプの追加
```typescript
ARCHETYPES = [
  // ... existing
  "マトリックス (4象限 / 2x2分析)"
]
```

#### 2. 新しいスタイルの追加
```typescript
STYLE_PROMPTS = {
  // ... existing
  "黒板アート (Blackboard Art)": "Style: Blackboard chalk drawing..."
}
```

#### 3. UI/UX改善
- スタイル選択をグリッド形式に変更（視覚的プレビュー付き）
- 参考画像の役割選択機能（メイン / 解説者）
- 入力ヒントセクションの追加
- スタイルのみ変更ボタンの実装

### Phase 2: モバイルAPI制限への対応（試行錯誤）

#### 試行1: 画像の軽量化（512px + 0.5品質）
**実装内容:**
```typescript
const MAX_DIM = 512;
const compressedBase64 = canvas.toDataURL('image/jpeg', 0.5);
```

**結果:** ドラフト生成も失敗。品質低下によりAIの理解力が低下。

#### 試行2: 清書時の画像送信廃止
**実装内容:**
```typescript
refImages: [] // Step 4で画像を送らない
```

**結果:** デザインの一貫性が失われ、清書の品質が低下。

#### 試行3: サーバー側フォールバックの実装
**実装内容:**
```typescript
const modelsToTry = [
  "nano-banana-pro-preview",
  "gemini-2.0-flash-exp", 
  "gemini-1.5-flash"
];
```

**結果:** モデル切り替えは機能するが、根本的な解決には至らず。

### Phase 3: 最終的な解決策（復元と最適化）

#### ユーザーフィードバック
「ドラフトも出力されなくなった。清書も状況変わらないので、一つ前のドラフトまでは動いていた状況に戻してください。」

#### 最終実装
1. **画像品質の復元:**
   - 解像度: 1000px（元の設定に戻す）
   - 圧縮品質: 0.8（AIの理解力を確保）

2. **サーバー側の堅牢化:**
   ```typescript
   // タイムアウトを90秒に延長
   const timeoutPromise = new Promise((_, reject) => 
     setTimeout(() => reject(new Error(`Timeout`)), 90000)
   );
   
   // 制限エラー時の待機
   if (lastError.includes('quota') || lastError.includes('429')) {
     await new Promise(r => setTimeout(r, 1000));
     continue;
   }
   ```

3. **清書時のドラフト参照を復元:**
   ```typescript
   const finalRefData = (draftImage && draftImage.includes('image/')) 
     ? await getDownscaledImage(draftImage) 
     : null;
   
   refImages: isRefine ? [] : (finalRefData 
     ? [{ data: finalRefData, mimeType: "image/jpeg" }] 
     : [])
   ```

### 学んだこと

1. **品質とパフォーマンスのバランス:**
   - 極端な軽量化（512px）はAIの理解力を損なう
   - 1000pxが品質とトークン消費の最適なバランス

2. **モバイル環境の特性:**
   - タイムアウト時間の延長が重要（90秒）
   - 連続リクエストによるスパム判定を避けるための待機時間

3. **デザインの一貫性:**
   - 清書時にドラフト画像を参照することで、構造の一貫性を確保
   - プロンプトのみでは微細な配置の再現が困難

### 最終的な設定

**画像処理:**
- 参考画像: 1000px, 0.8品質
- ドラフト参照: 1000px, 0.8品質（清書時）

**サーバー設定:**
- タイムアウト: 90秒
- フォールバック: nano-banana → 2.0-flash → 1.5-pro → 1.5-flash
- リトライ間隔: 1秒

**APIキー管理:**
- localStorage保存と自動適用
- 下4桁表示による確認機能
- 共有キー使用時の警告

---

## 技術的な洞察

### モバイルAPI制限の本質
有料キーでも制限が出る理由は、**RPM（Requests Per Minute）ではなくTPM（Tokens Per Minute）**の制限。スマホの高解像度画像は1枚で数千〜数万トークンを消費し、短時間に複数回の生成を行うと上限に達する。

### 解決のアプローチ
1. **品質を犠牲にしない範囲での最適化**（1000px, 0.8品質）
2. **サーバー側での粘り強いリトライ**（90秒タイムアウト、自動フォールバック）
3. **ユーザーへの透明性**（APIキー状態の可視化、詳細なエラーメッセージ）

この3つのアプローチにより、モバイル環境でも安定した図解生成を実現。
